<html>
<head>
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"
          integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.1.1/redux.min.js"
          crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/7.2.5/react-redux.min.js"></script>
</head>
<body>
<div id='root'></div>
<script type='text/babel'>

  // import {createStore} from 'redux';
  //
  // const notesReducer = (state = [], action) => {
  //   switch (action.type) {
  //     default:
  //       return state;
  //   }
  // }
  //
  // const store = createStore(notesReducer);

  class SignIn extends React.Component {
    constructor() {
      super();
      this.state = {
        username: '',
        password: ''
      };
      this.onChange = this.onChange.bind(this);
      this.onSubmit = this.onSubmit.bind(this);
    }

    onChange(ev) {
      this.setState({[ev.target.name]: ev.target.value});
    }

    onSubmit(ev) {
      ev.preventDefault();
      const {username, password} = this.state;
      this.props.signIn({
        username,
        password
      });
    }

    render() {
      const {onChange, onSubmit} = this;
      const {username, password} = this.state;
      return (
        <form onSubmit={onSubmit}>
          <input value={username} onChange={onChange} name='username'/>
          <input value={password} onChange={onChange} name='password'/>
          <button>Sign In</button>
        </form>
      );
    }
  }


  class App extends React.Component {
    constructor() {
      super();
      this.state = {
        loggedIn: false,
        username: null,
        id: null,
        notes: []
      };
      this.signIn = this.signIn.bind(this);
      this.logout = this.logout.bind(this);
      this.fetchNotes = this.fetchNotes.bind(this);
    }

    componentDidMount() {
      this.attemptTokenLogin();
    }

    componentDidUpdate(prevProps, prevState) {
      if(prevState.loggedIn !== this.state.loggedIn) {
        this.fetchNotes();
      }
    }

    async attemptTokenLogin() {
      try {
        if(!this.loggedIn) {
          const {data} = await axios.get('/api/auth');
          console.log('data', data);
          this.setState({
            ...data
          });
        }
      }
      catch(err) {
        console.log(err);
      }
      // }
    }

    async signIn(credentials) {
      try {
        let {data} = await axios.post('/api/auth', credentials);
        this.setState({
          ...data
        })
      }
      catch(err) {
        console.log('signin err', err);
      }
    }

    async logout() {
      try {
        let {data} = await axios.get('/api/auth/logout');
        this.setState({
          ...data
        })
      }
      catch(err) {
        console.log('signin err', err);
      }
    }

    async fetchNotes() {
      if(this.state.loggedIn) {
        try {
          const response = await axios.get(`/api/user/${this.state.id}/notes`);
          this.setState({
            notes: response.data
          });
          //set the state
        } catch (err) {
          console.log(err)
        }
      }
    }





    render() {
      const {loggedIn} = this.state;
      const {signIn, logout} = this;

      if (!loggedIn) {
        return <SignIn signIn={signIn}/>
      }
      else {
        return (
          <div>
            Welcome {this.state.username}
            <button onClick={logout}>Logout</button>
            <ul>
              {
                this.state.notes.map(note => <li>{note.note}</li>)
              }
            </ul>
          </div>
        );
      }
    }
  }

  ReactDOM.render(
    // <Provider store={store}>
    <App/>
    // </Provider>
      , document.querySelector('#root'));
</script>
</body>
</html>
